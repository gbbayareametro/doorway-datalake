version: 0.2
env:
  shell: bash
  variables:
    PGDATABASE: test
  secrets-manager:
    PGUSER: DoorwayDatalakeStackSecretD-6hmkHqeIWdIa:username
    PGPASSWORD: DoorwayDatalakeStackSecretD-6hmkHqeIWdIa:password
    PGHOST: DoorwayDatalakeStackSecretD-6hmkHqeIWdIa:host

phases:
  install:
    commands:
      - npm install aws-cdk -g
      - yarn install
      - sudo yum install -y postgresql15
  build:
    commands:
      - export DATABASE_URL="postgres://${PGUSER}:${PGPASSWORD}@${PGHOST}:5432"
      - echo "DATABASE_URL=${DATABASE_URL}" >> .env
      - createdb test
      - yarn build
      - yarn prisma migrate dev --name init
      - yarn cdk synth
      - yarn cdk deploy
